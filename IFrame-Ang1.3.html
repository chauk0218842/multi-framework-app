<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>IFrame Angular 1.3 Client</title>
    <link rel="stylesheet" href="CSS/Styles.css">
</head>
<body ng-app = "PMClient" ng-controller = "PMCCtrl">

<script src="bower_components/angular/angular.js"></script>
<script src="JS/fnDeferCreate_Angular.js"></script>
<script src="JS/DeferHASH.js"></script>
<script src="JS/PMConstants.js"></script>
<script src="JS/PMError.js"></script>
<script src="JS/PMData.js"></script>
<script src="JS/PMClient.js"></script>
<script src="JS/PMCLibrary.js"></script>
<script>

    angular.module ("PMClient", [])
        .factory ("PMCLib", function ($q) {

            var _fnCreateDefer = fnDeferCreate_Angular ($q);
            var _DeferHASH  = DeferHASH (_fnCreateDefer);
            var _PMClient = PMClient (PMConstants, PMError, PMData);
            return PMCLibrary (_PMClient, _DeferHASH);
        })
        .controller ("PMCCtrl", function ($window, $scope, PMCLib) {

            var _VM = $scope;
            _VM.clientName = PMCLib.getClientName();
            _VM.response = "";

            angular.element($window).on ("message", function (__oEvent) {

                _VM.$apply (function () {

                    /**
                     * Listen for messages
                     */
                    PMCLib.receive (__oEvent);

                    /**
                     * Update response
                     */
                    var ___oMessages = PMCLib.getMessages ();
                    _VM.response = (___oMessages.length ? ___oMessages [___oMessages.length - 1] + "\n--\n" : "") + _VM.response;
                });

            });

            angular.element ($window).on ("unload", function () {
                $window.removeEventListener ("message");
            })

            PMCLib.connect ();

        })

        .directive ("pmcResponse", function () {
            return {
                restrict : "E",
                template : '<textarea ng-model = "response" class = "response"></textarea>'
            };
        })
        .directive ("pmcContacts", function (PMCLib) {
            return {
                restrict :  "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.contacts = "";
                    _VM.recipient = "";

                    PMCLib.getContacts ().then (function (_oContacts) {
                        _VM.contacts = _oContacts;
                        _VM.recipient = _VM.contacts [0];
                    })

                    _VM.refreshContacts = function () {
                        PMCLib.getContacts ().then (function (_oContacts) {
                            _VM.contacts = _oContacts;
                        });
                    };

                },
                template : "Contacts " +
                    '<select ng-model = "recipient"><option ng-repeat="contact in contacts" value="{{contact}}">{{contact}}</option></select>' + ' ' +
                    '<button ng-click = "refreshContacts()">Refresh</button>'
            };
        })
        .directive ("pmcMessage", function (PMCLib) {
            return {
                restrict :  "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.message = "Your message here...";
                    _VM.sendMessage = function () {
                        PMCLib.send ($scope.recipient, $scope.message)
                    };

                },
                template : 'Message' +
                    '<br/><textarea ng-model = "message" class = "message">Your message here</textarea>' +
                    '<button ng-click = "sendMessage ()">Send</button>'
            };
        })

</script>

<h3>{{clientName}} (Powered by Angular 1.3)</h3>

<pmc-connect></pmc-connect>

<pmc-response></pmc-response>
<p>
    <pmc-contacts></pmc-contacts>
</p>
<p>
    <pmc-message></pmc-message>
</p>



</body>
</html>