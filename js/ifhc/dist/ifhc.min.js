var ifhc=function(e){"use strict";function t(e){function t(t){parent.postMessage(t,e.DOMAIN_NAME)}function n(e){return e.data}return{send:t,listen:n}}function n(e){function t(){function e(e){return r[e]}function t(e,t){if("string"!=typeof e&&"number"!=typeof e)throw new Error(0,"invalid key type");return r[e]=t,r[e]}function n(e){r[e]=null}var r={};return{get:e,set:t,remove:n}}function n(t){return e(t)}return{create:t,createKey:n}}function r(e){function t(e){var t=i(e);return t.list=e.list,t}function n(e){var t=i(e);return t.body=e.body,t}function r(e){var t=i(e);return t.files=e.files,t}function i(t){return{type:t.type||e.GENERIC_TYPE,sender:t.sender,recipient:t.recipient,receipt:t.receipt}}function c(c){var o={};return o[e.CLIENT_LIST_TYPE]=t,o[e.TEXT_MESSAGE_TYPE]=n,o[e.FILES_TYPE]=r,o[c.type]?o[c.type](c):i(null)}return{"const":e,create:c}}function i(e,t){function n(e){o.push(e),s.set(e,o[o.length-1])}function r(e){s.remove(e)}function i(){return o.sort()}function c(t,n){document.getElementById(t).contentWindow.postMessage(n,e.DOMAIN_NAME)}var o=[],s=t.create();return{"const":e,addClient:n,removeClient:r,getClientList:i,send:c}}function c(e){function t(e,t,n,r){return{id:e,uri:t,client:n,"package":r}}function n(e,n){return t(e.id,e.uri,e.client,n)}function r(n,r,o){return t(String(e(i+c++)),n,r,o)}var i="A",c=0;return{create:r,createResponse:n}}function o(){function e(e){return e>=1e9?e=(e/1e9).toFixed(2)+" GB":e>=1e6?e=(e/1e6).toFixed(2)+" MB":e>=1e3?e=(e/1e3).toFixed(2)+" KB":e>1?e+=" bytes":1==e?e+=" byte":e="0 byte",e}function t(t){for(var n,r="",i=0;n=t[i];i++)r+=i+1+". "+n.name+" ("+e(n.size)+")\n";return r}return{formatBytesToUnits:e,createFileList:t}}function s(e,t,n,r,i,c){function o(e){var n=t.listen(e),r=N.get(n.id);return h.push(n),r&&r.resolve(n),console.log("%CLIENT% > Received a response from host: %RESPONSE%".replace(/%CLIENT%/g,C).replace(/%RESPONSE%/g,e.data.toString())),c.when(i.process(n.package))}function s(e){var n=N.set(e.id,c.create());return S.push(e),t.send(e),console.log('%CLIENT% > Sent a request to host: "%URI%"'.replace(/%CLIENT%/g,C).replace(/%URI%/g,e.uri)),n}function a(){return s(n.create(r.CONNECT_CLIENT,C,null)).then(function(e){return e.package})}function u(){return s(n.create(r.DISCONNECT_CLIENT,C,null)).then(function(e){return e.package})}function E(){return s(n.create(r.REQUEST_CLIENT_LIST,C,null)).then(function(e){return e.package})}function f(e,t,c){for(var o=[],a=0,u=e.length;u>a;a++){var E=i.create({type:i.const.TEXT_MESSAGE_TYPE,sender:C,recipient:e[a],body:t,receipt:c});o.push(s(n.create(r.SEND_CLIENT_PACKAGE,C,E)))}return o}function l(e,t,c){for(var o=[],a=0,u=e.length;u>a;a++){var E=i.create({type:i.const.FILES_TYPE,sender:C,recipient:e[a],files:t,receipt:c});o.push(s(n.create(r.SEND_CLIENT_PACKAGE,C,E)))}return o}function p(){return C}function T(){return S}function d(){return h}var g=location.toString().replace(/^[^\?]+\?/g,""),_=g.split("&"),C=_[0].replace(/^id=/g,""),N=e.create(),S=[],h=[];return{listen:o,connect:a,disconnect:u,getUsername:p,getClients:E,getRequestLog:T,getResponseLog:d,sendFiles:l,sendMessage:f}}function a(e){function t(t){e.process(t.data),console.log("HOST > Processing a request: %URI%".replace(/%URI%/g,t.data.uri))}return{listen:t}}function u(e,t,n,r){function i(e){return e.list=["ALL"].concat(e.list),r.when(e)}function c(e){return e.body="%CLIENT% > %MESSAGE%<hr/>".replace(/%CLIENT%/g,e.sender).replace(/%MESSAGE%/g,e.body),r.when(e)}function o(i){function c(e){var t=e.file,r=e.url;E++,0===t.type.indexOf("image/")?o+="<br/>"+E+'. <a href = "'+r+'" target = "new">'+t.name+"</a> ("+n(t.size)+')<br/><a href = "'+r+'" target = "new"><img class = "thumbnail" src = '+r+"></a><br/>":0===t.type.indexOf("text/")?o+="<br/>"+E+'. <a href = "'+r+'" target = "new">'+t.name+"</a> ("+n(t.size)+")<br/>":"application/json"===t.type&&(o+="<br/>"+E+'. <a href = "'+r+'" target = "new">'+t.name+"</a> ("+n(t.size)+")<br/>")}for(var o="",s=[],a=e.create(),u=i.files,E=0,f=0,l=u.length;l>f;f++){var p=new FileReader,T=a.set(f,r.create());s.push(T),T.then(c),p.onloadend=function(e,t){return function(n){n.target.readyState==FileReader.DONE&&a.get(e).resolve({file:t,url:n.target.result})}}(f,u[f]),p.readAsDataURL(u[f])}return r.all(s).then(function(){return t.create({type:t.const.TEXT_MESSAGE_TYPE,sender:i.sender,recipient:i.recipient,body:"%CLIENT% > Received files...<br />".replace(/%CLIENT%/g,i.recipient)+o+"<hr/>",useReceipt:i.receipt})})}function s(e){var n={};return n[t.const.CLIENT_LIST_TYPE]=i,n[t.const.TEXT_MESSAGE_TYPE]=c,n[t.const.FILES_TYPE]=o,r.when(n[e.type](e))}var a=t;return a.process=s,a}function E(e,t,n,r,i){function c(r){var i=n.create({type:n.const.TEXT_MESSAGE_TYPE,sender:t.const.SERVER_NAME,recipient:r.client,body:"Connected to host",useReceipt:!1});t.addClient(r.client),t.send(r.client,e.createResponse(r,i))}function o(r){var i=n.create({type:n.const.TEXT_MESSAGE_TYPE,sender:t.const.SERVER_NAME,recipient:r.client,body:"Disconnected from host",useReceipt:!1});t.removeClient(r.client),t.send(r.client,e.createResponse(r,i))}function s(e){for(var n=t.getClientList(),r=[],i=0,c=n.length;c>i;i++)n[i]!==e&&r.push(n[i]);return r}function a(){for(var i=t.getClientList(),c=0,o=i.length;o>c;c++){var a=i[c],u=n.create({type:n.const.CLIENT_LIST_TYPE,list:s(a)});t.send(a,e.create(r.REQUEST_CLIENT_LIST,a,u))}}function u(r){var i=n.create({type:n.const.CLIENT_LIST_TYPE,list:s(r.client)});t.send(r.client,e.createResponse(r,i))}function E(n){t.send(n.package.recipient,e.createResponse(n,n.package))}function f(r){var i=n.create({type:n.const.TEXT_MESSAGE_TYPE,sender:t.const.SERVER_NAME,recipient:r.client,body:"you 404'ed!!",useReceipt:!1});t.send(r.client,e.createResponse(r,i))}function l(e){e.uri===r.CONNECT_CLIENT?(c(e),a()):e.uri===r.DISCONNECT_CLIENT?(o(e),a()):e.uri===r.REQUEST_CLIENT_LIST?u(e):e.uri===r.SEND_CLIENT_PACKAGE?E(e):i||f(trans)}return{"const":r,process:l}}if("undefined"==typeof e.btoa)return void console.error("cannot instantiate ifhc: base64 encoder not available");var f=null;"undefined"!=typeof ifhc?f=ifhc:"undefined"!=typeof e.ifhc&&(f=e.ifhc),f=f||{},f.version="1.0.1",ifhc=e.ifhc=f;var l=e.btoa,p={GENERIC_TYPE:"generic type",CLIENT_LIST_TYPE:"client list type",TEXT_MESSAGE_TYPE:"text message type",FILES_TYPE:"files type"},T={SERVER_NAME:"Window",DOMAIN_NAME:"*"},d={CONNECT_CLIENT:"connect client",DISCONNECT_CLIENT:"disconnect client",REQUEST_CLIENT_LIST:"request client list",SEND_CLIENT_PACKAGE:"send client package"},g=o(),_={};return _.client=t(T),_.hash=n(l),_.packageConst=p,_.package=r(_.packageConst),_.serverConst=T,_.server=i(_.serverConst,_.hash),_.transmission=c(_.hash.createKey),f.const={},f.const.route=d,f.const.package=_.package.const,f.host=function(e){var t=E(_.transmission,_.server,_.package,f.const.route,e);return a(t)},f.client=function(e){if("undefined"==typeof e)return void console.error('cannot instantiate "client" - Deferred library not provided');var t=u(_.hash,_.package,g.formatBytesToUnits,e);return s(_.hash,_.client,_.transmission,f.const.route,t,e)},f.util=g,f}(window);