<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>IFrame Angular 1.3 Client</title>
    <link rel="stylesheet" href="CSS/Styles.css">
</head>
<body ng-app = "PMClient" ng-controller = "PMCCtrl">

<script src="bower_components/angular/angular.js"></script>
<script src="JS/PMConstants.js"></script>
<script src="JS/PMError.js"></script>
<script src="JS/PMData.js"></script>
<script src="JS/PMClient.js"></script>
<script>

    angular.module ("PMClient", [])
        .factory ("DeferHandler", function ($q) {
            var _oHASH = {};

            return {
                get : function (__sKey) {
                    return _oHASH [__sKey];
                },

                set : function (__sKey) {
                    _oHASH [__sKey] = $q.defer ();
                    return _oHASH [__sKey];
                },

                remove : function (__sKey) {
                    _oHASH [__sKey] = null;
                }
            };
        })
        .factory ("PMCLib", function ($window, DeferHandler) {

            function _fnConvertPMDataToString (__oPMData) {
                return ("%SENDER% (%REQUEST%) > %MESSAGE%")
                        .replace(/%SENDER%/g, __oPMData.sender)
                        .replace (/%REQUEST%/g, __oPMData.request)
                        .replace(/%MESSAGE%/g, __oPMData.message);
            }

            var _oMessages = [];
            var _sMessages = "";

            /**
             *  Append a listener first before connecting
             */
            angular.element($window).on ("message", function (__oEvent) {

                var __oPMData = PMClient.listen(__oEvent);

                /**
                 * Response made from this client only
                 */
                if (DeferHandler.get (__oPMData.id)) {
                    DeferHandler.get (__oPMData.id).resolve (__oPMData);
                }

                _oMessages.push (_fnConvertPMDataToString (__oPMData));
                _sMessages = _fnConvertPMDataToString (__oPMData) + "\n--\n" + _sMessages;

            });

            angular.element ($window).on ("unload", function () {
                $window.removeEventListener ("message");
            })

            function _fnConnect () {
                var __sMessageID = PMClient.connect ();
                return DeferHandler.set (__sMessageID).promise.then (function (__oPMData) {
                    return __oPMData.message;
                });
            }

            function _fnSendMessage (__sRecipient, __oMessage) {
                var __sMessageID = PMClient.send(__sRecipient === PMConstants.RECIPIENT.ALL ? PMConstants.REQUEST.POST_MESSAGE_CLIENTS : PMConstants.REQUEST.POST_MESSAGE_CLIENT, __sRecipient, __oMessage, false);
                return DeferHandler.set (__sMessageID).promise.then (function (__oPMData) {
                    return __oPMData.message;
                });
            }

            function _fnGetContacts () {

                var __sMessageID = PMClient.send(PMConstants.REQUEST.GET_CLIENTS, PMConstants.RECIPIENT.SERVER, null, false);
                return DeferHandler.set (__sMessageID).promise.then (function (__oPMData) {
                    return __oPMData.message;
                });
            }

            function _fnGetMessages () {
                return _sMessages;
            }

            /**
             * Connect to the PMServer
             */
            DeferHandler.set (PMClient.connect());

            return {

                connect : _fnConnect,

                getClientName: PMClient.getClientID,

                getContacts : _fnGetContacts,

                getMessages : _fnGetMessages,

                status : PMClient.status,

                send : _fnSendMessage

            };
        })

        .controller ("PMCCtrl", function ($scope, PMCLib) {
            var _VM = $scope;
            _VM.clientName = PMCLib.getClientName();

        })

        .directive ("pmcResponse", function (PMCLib) {
            return {
                restrict : "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.getResponse = PMCLib.getMessages;

                },
                template : '<textarea class = "response">{{getResponse()}}</textarea>'
            };
        })
        .directive ("pmcContacts", function (PMCLib) {
            return {
                restrict :  "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.contacts = "";
                    _VM.recipient = "";

                    PMCLib.getContacts ().then (function (_oContacts) {
                        _VM.contacts = _oContacts;
                        _VM.recipient = _VM.contacts [0];
                    })

                    _VM.refreshContacts = function () {
                        PMCLib.getContacts ().then (function (_oContacts) {
                            _VM.contacts = _oContacts;
                        });
                    };

                },
                template : "Contacts " +
                    '<select ng-model = "recipient"><option ng-repeat="contact in contacts" value="{{contact}}">{{contact}}</option></select>' + ' ' +
                    '<button ng-click = "refreshContacts()">Refresh</button>'
            };
        })
        .directive ("pmcMessage", function (PMCLib) {
            return {
                restrict :  "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.message = "Your message here...";
                    _VM.sendMessage = function () {
                        PMCLib.send ($scope.recipient, $scope.message)
                    };

                },
                template : 'Message' +
                    '<br/><textarea ng-model = "message" class = "message">Your message here</textarea>' +
                    '<button ng-click = "sendMessage ()">Send</button>'
            };
        })

</script>

<h3>{{clientName}} (Powered by Angular 1.3)</h3>

<pmc-connect></pmc-connect>

<pmc-response></pmc-response>
<p>
    <pmc-contacts></pmc-contacts>
</p>
<p>
    <pmc-message></pmc-message>
</p>



</body>
</html>