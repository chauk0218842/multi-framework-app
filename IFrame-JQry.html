<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>IFrame JQuery Client</title>
    <link rel="stylesheet" href="CSS/Styles.css">
</head>
<body>

<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="JS/PMConstants.js"></script>
<script src="JS/PMError.js"></script>
<script src="JS/PMData.js"></script>
<script src="JS/PMClient.js"></script>
<script>

    function fnDocumentOnReady() {

        PMClient.connect();

        $("#refresh").bind("click", fnRefresh);
        $("#iframeName").text(PMClient.getClientID());
        $("#sendMessage").bind("click", fnSendMessage);

    }

    function fnDocumentOnMessage(_oEvent) {

        var _oPMData = PMClient.listen(_oEvent);

        if (_oPMData.request === PMConstants.REQUEST.POST_MESSAGE_CLIENTS ||
                _oPMData.request === PMConstants.REQUEST.POST_MESSAGE_CLIENT) {
            $("#response").val(("%SENDER% (%REQUEST%) > %MESSAGE%").replace(/%SENDER%/g, _oPMData.sender).replace (/%REQUEST%/g, _oPMData.request).replace(/%MESSAGE%/g, _oPMData.message) + "\n--\n" + $("#response").val());
        }

        else if (_oPMData.request === PMConstants.REQUEST.GET_CLIENTS) {

            $("#response").val(("%SENDER% (%REQUEST%) > %MESSAGE%").replace(/%SENDER%/g, _oPMData.sender).replace (/%REQUEST%/g, _oPMData.request).replace(/%MESSAGE%/g, _oPMData.message) + "\n--\n" + $("#response").val());
            var oRecipients = _oPMData.message;
            $("#recipient").empty();
            $("#recipient").append("<option value = \"" + PMConstants.RECIPIENT.ALL + "\">ALL</option>");

            for (var n in oRecipients) {
                $("#recipient").append("<option value = \"" + oRecipients [n] + "\">" + oRecipients [n] + "</option>");
            }

        }
    }

    function fnRefresh() {
        PMClient.send(PMConstants.REQUEST.GET_CLIENTS, PMConstants.RECIPIENT.SERVER, null, false);
    }

    function fnSendMessage() {
        var _sRecipient = $("#recipient").val();
        var _sMessage = $("#message").val();
        PMClient.send(_sRecipient === PMConstants.RECIPIENT.ALL ? PMConstants.REQUEST.POST_MESSAGE_CLIENTS : PMConstants.REQUEST.POST_MESSAGE_CLIENT, _sRecipient, _sMessage, false);
    }

    window.addEventListener("message", fnDocumentOnMessage, false);
    window.addEventListener("onunload", PMClient.disconnect, false);

    $("document").ready(fnDocumentOnReady);

</script>

<h3 id="iframeName"></h3>

<textarea id="response"></textarea>

<p>Recipient <select id="recipient"></select>
    <button id="refresh">Refresh</button>
</p>
<p>
    Message
    <br/><textarea id = "message">Your message here</textarea>
    <button id="sendMessage">Send</button>
</p>


</body>
</html>