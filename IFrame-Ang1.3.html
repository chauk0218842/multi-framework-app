<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>IFrame Angular 1.3 Client</title>
    <link rel="stylesheet" href="CSS/Styles.css">
</head>
<body ng-app = "PMClient" ng-controller = "PMCCtrl">

<script src="bower_components/angular/angular.js"></script>
<script src="JS/PMConstants.js"></script>
<script src="JS/PMError.js"></script>
<script src="JS/PMData.js"></script>
<script src="JS/PMClient.js"></script>
<script>

    angular.module ("PMClient", [])
        .factory ("PMCLib", function ($window) {
        
            var _oContacts = [];
            var _oLastMessage = "";
            var _oHistory = [];

            /**
             *  Append a listener first before connecting
             */
            angular.element($window).on ("message", function (__oEvent) {

                debugger;
                var __oPMData = PMClient.listen(__oEvent);

                if (__oPMData.request === PMConstants.REQUEST.GET_CLIENTS) {
                    _oContacts = __oPMData.message;
                }

                else {
                    _oLastMessage = ("%SENDER% (%REQUEST%) > %MESSAGE%").replace(/%SENDER%/g, __oPMData.sender).replace (/%REQUEST%/g, __oPMData.request).replace(/%MESSAGE%/g, __oPMData.message);
                }
                _oHistory.push ({ time : new Date (), message : __oPMData.message });

            });

            /**
             * Remove the message listener on close of this window
             * //$window.removeEventListener ("message");
             */

            /**
             * Connect to the PMServer
             */
            PMClient.connect();

            return {

                getClientName: function () {
                    return PMClient.getClientID ();
                },

                getContacts : function () {
                    return _oContacts;
                },

                status : function () {
                    return PMClient.status ();
                },

                sendMessage : function (_sRecipient, _oMessage) {
                    PMClient.send(_sRecipient === PMConstants.RECIPIENT.ALL ? PMConstants.REQUEST.POST_MESSAGE_CLIENTS : PMConstants.REQUEST.POST_MESSAGE_CLIENT, _sRecipient, _oMessage, false);
                },

                getMessage : function () {
                    return _oLastMessage;
                }
            };
        })

        .controller ("PMCCtrl", function ($scope, PMCLib) {
            var _VM = $scope;
            _VM.clientName = PMCLib.getClientName();

        })

        .directive ("pmcResponse", function (PMCLib) {
            return {
                restrict : "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.response = PMCLib.getMessage ()
                },
                template : '<textarea ng-model = "response" class = "response"></textarea>'
            };
        })
        .directive ("pmcRecipients", function (PMCLib) {
            return {
                restrict :  "E",
                controller : function ($scope) {

                    var _VM = $scope;

                    _VM.contacts = PMCLib.getContacts ();
                    _VM.recipient = _VM.contacts [0];
                    _VM.refreshContacts = function () {
                        debugger;
                        _VM.contacts = PMCLib.getContacts ();
                    };

                },
                template : "Recipients " +
                    '<select ng-model = "recipient"><option ng-repeat="contact in contacts" value="{{contact}}">{{contact}}</option></select>' + ' ' +
                    '<button ng-click = "refreshContacts()">Refresh</button>'
            };
        })
        .directive ("pmcMessage", function (PMCLib) {
            return {
                restrict :  "E",
                controller : function ($scope) {

                    var _VM = $scope;
                    _VM.sendMessage = function () {
                        _VM.sendMessage ($scope.recipient, $scope.message);
                    };

                },
                template : 'Message' +
                    '<br/><textarea ng-model = "message" class = "message">Your message here</textarea>' +
                    '<button ng-click = "sendMessage">Send</button>'
            };
        })

</script>

<h3>{{clientName}} (Powered by Angular 1.3)</h3>

<pmc-response></pmc-response>
<p>
    <pmc-recipients></pmc-recipients>
</p>
<p>
    <pmc-message></pmc-message>
</p>



</body>
</html>